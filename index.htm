<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استقبال الأرقام الافتراضية</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.19.2/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        * {
            font-family: 'Tajawal', sans-serif;
        }
        .bg-gradient {
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
        }
        .loading-dot {
            animation: loadingAnimation 1.5s infinite ease-in-out;
        }
        .loading-dot:nth-child(1) { animation-delay: 0s; }
        .loading-dot:nth-child(2) { animation-delay: 0.3s; }
        .loading-dot:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes loadingAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .country-flag {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 8px;
        }
        .toast {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .blink {
            animation: blinkAnimation 1s infinite;
        }
        @keyframes blinkAnimation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==============================================
        // مكونات الواجهة الأمامية
        // ==============================================

        // مكون لعرض الإشعارات
        const Toast = ({ message, type, onClose }) => {
            const bgColor = {
                success: 'bg-green-100 border-green-200 text-green-800',
                error: 'bg-red-100 border-red-200 text-red-800',
                info: 'bg-blue-100 border-blue-200 text-blue-800',
                warning: 'bg-yellow-100 border-yellow-200 text-yellow-800'
            };
            
            const icon = {
                success: 'M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z',
                error: 'M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z',
                info: 'M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z',
                warning: 'M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z'
            };
            
            return (
                <div className={`fixed bottom-5 right-5 border rounded-lg p-4 flex items-start shadow-lg toast ${bgColor[type]}`}>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                        <path fillRule="evenodd" d={icon[type]} clipRule="evenodd" />
                    </svg>
                    <div className="mr-2 ml-2">
                        <div className="font-medium">{type === 'success' ? 'نجاح' : type === 'error' ? 'خطأ' : type === 'warning' ? 'تحذير' : 'ملاحظة'}</div>
                        <div className="text-sm">{message}</div>
                    </div>
                    <button onClick={onClose} className="text-xl font-bold opacity-70 hover:opacity-100">
                        &times;
                    </button>
                </div>
            );
        };

        // مكون تسجيل الدخول والتسجيل
        const LoginForm = ({ onLogin, showToast }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignup, setIsSignup] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [name, setName] = useState('');
            const [twoFactorCode, setTwoFactorCode] = useState('');
            const [showTwoFactor, setShowTwoFactor] = useState(false);
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                
                try {
                    // محاكاة لاستدعاء API حقيقي
                    const response = await mockApiCall({
                        endpoint: isSignup ? '/api/users/register' : '/api/users/login',
                        method: 'POST',
                        data: isSignup ? { name, email, password } : { email, password }
                    });
                    
                    if (response.success) {
                        if (response.twoFactorRequired && !showTwoFactor) {
                            setShowTwoFactor(true);
                            showToast('تم إرسال رمز التحقق إلى بريدك الإلكتروني', 'info');
                        } else {
                            showToast(response.message, 'success');
                            onLogin({ 
                                email, 
                                token: response.token,
                                twoFactorEnabled: response.twoFactorEnabled
                            });
                        }
                    } else {
                        showToast(response.message, 'error');
                    }
                } catch (error) {
                    showToast('حدث خطأ في الاتصال بالخادم', 'error');
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
                    <h2 className="text-3xl font-bold text-center text-indigo-600 mb-6">
                        {isSignup ? 'إنشاء حساب جديد' : 'تسجيل الدخول'}
                    </h2>
                    <form onSubmit={handleSubmit}>
                        {isSignup && (
                            <div className="mb-4">
                                <label className="block text-gray-700 font-medium mb-2">الاسم الكامل</label>
                                <input
                                    type="text"
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="أدخل اسمك الكامل"
                                    value={name}
                                    onChange={(e) => setName(e.target.value)}
                                    required
                                />
                            </div>
                        )}
                        <div className="mb-4">
                            <label className="block text-gray-700 font-medium mb-2">البريد الإلكتروني</label>
                            <input
                                type="email"
                                className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder="أدخل بريدك الإلكتروني"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                            />
                        </div>
                        <div className="mb-6">
                            <label className="block text-gray-700 font-medium mb-2">كلمة المرور</label>
                            <input
                                type="password"
                                className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                placeholder={isSignup ? 'اختر كلمة مرور قوية' : 'أدخل كلمة المرور'}
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                                minLength="6"
                            />
                        </div>
                        
                        {showTwoFactor && (
                            <div className="mb-4">
                                <label className="block text-gray-700 font-medium mb-2">رمز التحقق الثنائي</label>
                                <input
                                    type="text"
                                    className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                    placeholder="أدخل رمز التحقق المكون من 6 أرقام"
                                    value={twoFactorCode}
                                    onChange={(e) => setTwoFactorCode(e.target.value)}
                                    required
                                    maxLength="6"
                                />
                            </div>
                        )}
                        
                        <button
                            type="submit"
                            className={`w-full bg-gradient text-white font-medium py-3 rounded-lg shadow-md hover:opacity-90 transition-all ${isLoading ? 'opacity-75 cursor-not-allowed' : ''}`}
                            disabled={isLoading}
                        >
                            {isLoading ? (
                                <div className="flex justify-center items-center">
                                    <span className="loading-dot bg-white w-2 h-2 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-white w-2 h-2 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-white w-2 h-2 rounded-full mx-1"></span>
                                </div>
                            ) : isSignup ? 'إنشاء حساب' : 'تسجيل الدخول'}
                        </button>
                    </form>
                    <div className="mt-6 text-center">
                        <button
                            className="text-indigo-600 hover:text-indigo-800 font-medium"
                            onClick={() => setIsSignup(!isSignup)}
                        >
                            {isSignup ? 'لديك حساب بالفعل؟ تسجيل الدخول' : 'ليس لديك حساب؟ إنشاء حساب جديد'}
                        </button>
                    </div>
                </div>
            );
        };

        // مكون اختيار الدولة
        const CountrySelector = ({ onSelect, showToast }) => {
            const [countries, setCountries] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [cacheTimestamp, setCacheTimestamp] = useState(null);
            
            useEffect(() => {
                const fetchCountries = async () => {
                    try {
                        // التحقق من وجود بيانات في التخزين المؤقت
                        const cachedData = localStorage.getItem('cachedCountries');
                        const cachedTimestamp = localStorage.getItem('cachedCountriesTimestamp');
                        
                        // إذا كانت البيانات موجودة في الكاش ولم تنته صلاحيتها (5 دقائق)
                        if (cachedData && cachedTimestamp && Date.now() - parseInt(cachedTimestamp) < 300000) {
                            setCountries(JSON.parse(cachedData));
                            setCacheTimestamp(parseInt(cachedTimestamp));
                            setIsLoading(false);
                            return;
                        }
                        
                        // محاكاة لاستدعاء API حقيقي
                        const response = await mockApiCall({
                            endpoint: '/api/countries',
                            method: 'GET'
                        });
                        
                        if (response.success) {
                            setCountries(response.data);
                            // تخزين البيانات في الكاش
                            localStorage.setItem('cachedCountries', JSON.stringify(response.data));
                            localStorage.setItem('cachedCountriesTimestamp', Date.now().toString());
                            setCacheTimestamp(Date.now());
                        } else {
                            showToast(response.message, 'error');
                        }
                    } catch (error) {
                        showToast('حدث خطأ في جلب بيانات الدول', 'error');
                    } finally {
                        setIsLoading(false);
                    }
                };
                
                fetchCountries();
            }, []);
            
            const filteredCountries = countries.filter(country => 
                country.name.includes(searchQuery) || 
                country.code.includes(searchQuery.toUpperCase())
            );
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                    <h2 className="text-2xl font-bold text-center text-indigo-600 mb-6">اختر الدولة</h2>
                    <div className="mb-6">
                        <input
                            type="text"
                            className="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="بحث عن دولة..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                        />
                    </div>
                    
                    {cacheTimestamp && (
                        <div className="text-xs text-gray-500 mb-2">
                            آخر تحديث: {new Date(cacheTimestamp).toLocaleTimeString()}
                        </div>
                    )}
                    
                    <div className="max-h-96 overflow-y-auto">
                        {isLoading ? (
                            <div className="h-32 flex items-center justify-center">
                                <div className="flex">
                                    <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                                </div>
                            </div>
                        ) : filteredCountries.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                لا توجد دول متطابقة مع بحثك
                            </div>
                        ) : (
                            filteredCountries.map(country => (
                                <div
                                    key={country.code}
                                    className="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                                    onClick={() => onSelect(country)}
                                >
                                    <div className="flex items-center">
                                        <img 
                                            src={`https://flagcdn.com/w40/${country.code.toLowerCase()}.png`} 
                                            alt={country.name} 
                                            className="country-flag" 
                                            onError={(e) => {
                                                e.target.src = 'https://via.placeholder.com/24';
                                            }}
                                        />
                                        <span className="font-medium">{country.name}</span>
                                    </div>
                                    <div className="flex items-center">
                                        <span className="text-sm text-gray-500 ml-2">متاح:</span>
                                        <span className={`${country.available > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded-full text-xs font-medium`}>
                                            {country.available > 0 ? country.available : 'غير متوفر'}
                                        </span>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // مكون عرض الرقم المؤقت
        const PhoneNumber = ({ country, onRequestNewNumber, onReceiveSMS, showToast, user, socket }) => {
            const [number, setNumber] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [timeLeft, setTimeLeft] = useState(600); // 10 دقائق بالثواني
            const [service, setService] = useState('');
            const [services, setServices] = useState([]);
            const [numberId, setNumberId] = useState(null);
            const [isWaitingForSMS, setIsWaitingForSMS] = useState(false);
            
            useEffect(() => {
                const fetchServices = async () => {
                    try {
                        // التحقق من وجود بيانات في التخزين المؤقت
                        const cachedServices = localStorage.getItem('cachedServices');
                        
                        if (cachedServices) {
                            setServices(JSON.parse(cachedServices));
                            return;
                        }
                        
                        // محاكاة لاستدعاء API حقيقي
                        const response = await mockApiCall({
                            endpoint: '/api/services',
                            method: 'GET'
                        });
                        
                        if (response.success) {
                            setServices(response.data);
                            localStorage.setItem('cachedServices', JSON.stringify(response.data));
                        } else {
                            showToast(response.message, 'error');
                        }
                    } catch (error) {
                        showToast('حدث خطأ في جلب الخدمات', 'error');
                    }
                };
                
                fetchServices();
            }, []);
            
            useEffect(() => {
                const requestNewNumber = async () => {
                    setIsLoading(true);
                    setNumber(null);
                    setNumberId(null);
                    
                    try {
                        // محاكاة لاستدعاء API حقيقي
                        const response = await mockApiCall({
                            endpoint: '/api/numbers/request',
                            method: 'POST',
                            data: { country: country.code }
                        });
                        
                        if (response.success) {
                            setNumber(response.data.number);
                            setNumberId(response.data.id);
                            setTimeLeft(response.data.expiresIn);
                            showToast('تم الحصول على رقم جديد بنجاح', 'success');
                            
                            // الانضمام إلى غرفة WebSocket لهذا الرقم
                            if (socket) {
                                socket.emit('joinNumberRoom', response.data.id);
                            }
                        } else {
                            showToast(response.message, 'error');
                        }
                    } catch (error) {
                        showToast('حدث خطأ في طلب الرقم', 'error');
                    } finally {
                        setIsLoading(false);
                    }
                };
                
                if (country) {
                    requestNewNumber();
                }
                
                // عداد تنازلي
                const interval = setInterval(() => {
                    setTimeLeft(time => {
                        if (time <= 1) {
                            clearInterval(interval);
                            return 0;
                        }
                        return time - 1;
                    });
                }, 1000);
                
                return () => {
                    clearInterval(interval);
                    // مغادرة غرفة WebSocket عند ترك المكون
                    if (socket && numberId) {
                        socket.emit('leaveNumberRoom', numberId);
                    }
                };
            }, [country, onRequestNewNumber]);
            
            // الاستماع لرسائل WebSocket
            useEffect(() => {
                if (!socket) return;
                
                const handleNewMessage = (message) => {
                    if (message.numberId === numberId) {
                        onReceiveSMS(message.code, service, message.text);
                        setIsWaitingForSMS(false);
                    }
                };
                
                socket.on('newSMS', handleNewMessage);
                
                return () => {
                    socket.off('newSMS', handleNewMessage);
                };
            }, [socket, numberId, service]);
            
            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            };
            
            const handleCopyNumber = () => {
                navigator.clipboard.writeText(number);
                showToast('تم نسخ الرقم إلى الحافظة', 'success');
            };
            
            const handleRequestNewNumber = async () => {
                setIsLoading(true);
                try {
                    // محاكاة لاستدعاء API حقيقي
                    const response = await mockApiCall({
                        endpoint: `/api/numbers/${numberId}/release`,
                        method: 'POST'
                    });
                    
                    if (response.success) {
                        showToast('تم تحرير الرقم القديم', 'info');
                        onRequestNewNumber();
                    } else {
                        showToast(response.message, 'error');
                    }
                } catch (error) {
                    showToast('حدث خطأ في طلب رقم جديد', 'error');
                }
            };
            
            const handleCheckSMS = async () => {
                if (!service) {
                    showToast('يجب اختيار الخدمة أولاً', 'warning');
                    return;
                }
                
                setIsWaitingForSMS(true);
                
                try {
                    // محاكاة لاستدعاء API حقيقي
                    const response = await mockApiCall({
                        endpoint: `/api/numbers/${numberId}/messages`,
                        method: 'GET'
                    });
                    
                    if (response.success && response.data.length > 0) {
                        const latestMessage = response.data[0];
                        onReceiveSMS(latestMessage.code, service, latestMessage.text);
                    } else {
                        showToast('جاري انتظار الرسالة... سيتم إعلامك عند وصولها', 'info');
                    }
                } catch (error) {
                    showToast('حدث خطأ في التحقق من الرسائل', 'error');
                } finally {
                    setIsWaitingForSMS(false);
                }
            };
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                    <div className="flex items-center justify-between mb-6">
                        <h2 className="text-2xl font-bold text-indigo-600">الرقم المؤقت</h2>
                        <div className="flex items-center">
                            <img 
                                src={`https://flagcdn.com/w40/${country.code.toLowerCase()}.png`} 
                                alt={country.name} 
                                className="country-flag"
                                onError={(e) => {
                                    e.target.src = 'https://via.placeholder.com/24';
                                }}
                            />
                            <span className="font-medium">{country.name}</span>
                        </div>
                    </div>
                    
                    {isLoading ? (
                        <div className="h-32 flex items-center justify-center">
                            <div className="flex">
                                <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                                <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                                <span className="loading-dot bg-indigo-600 w-3 h-3 rounded-full mx-1"></span>
                            </div>
                        </div>
                    ) : (
                        <>
                            <div className="mb-6">
                                <div className="bg-gray-50 p-4 rounded-lg flex items-center justify-between">
                                    <div className="text-xl font-bold tracking-wider">{number}</div>
                                    <button 
                                        className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-lg hover:bg-indigo-200 transition-colors"
                                        onClick={handleCopyNumber}
                                    >
                                        نسخ
                                    </button>
                                </div>
                                <div className="mt-2 text-sm text-gray-500 flex justify-between">
                                    <span>الوقت المتبقي: {formatTime(timeLeft)}</span>
                                    <span>رقم مؤقت صالح لمرة واحدة</span>
                                </div>
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-gray-700 font-medium mb-2">اختر الخدمة</label>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    {services.map(s => (
                                        <button
                                            key={s}
                                            className={`px-3 py-2 rounded-lg text-sm font-medium ${service === s ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}
                                            onClick={() => setService(s)}
                                        >
                                            {s}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    className={`flex-1 bg-indigo-600 text-white font-medium py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors ${!service || isWaitingForSMS ? 'opacity-50 cursor-not-allowed' : ''}`}
                                    onClick={handleCheckSMS}
                                    disabled={!service || isWaitingForSMS}
                                >
                                    {isWaitingForSMS ? (
                                        <span className="flex items-center justify-center">
                                            <span className="loading-dot bg-white w-2 h-2 rounded-full mx-1"></span>
                                            جاري التحقق...
                                        </span>
                                    ) : 'التحقق من الرسائل'}
                                </button>
                                <button
                                    className="px-4 bg-gray-200 text-gray-800 font-medium py-3 rounded-lg shadow-md hover:bg-gray-300 transition-colors"
                                    onClick={handleRequestNewNumber}
                                >
                                    رقم جديد
                                </button>
                            </div>
                            
                            {user.subscription === 'free' && (
                                <div className="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <div className="flex items-center text-yellow-800">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                        </svg>
                                        حساب مجاني
                                    </div>
                                    <p className="mt-2 text-sm text-yellow-700">
                                        لديك {user.remainingNumbers} أرقام متبقية اليوم. ترقية للحصول على أرقام غير محدودة.
                                    </p>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };

        // مكون استقبال الرسائل
        const SMSReceiver = ({ code, service, message, onBack, onRefresh, showToast }) => {
            const [isRefreshing, setIsRefreshing] = useState(false);
            
            const handleRefresh = async () => {
                setIsRefreshing(true);
                try {
                    await onRefresh();
                    showToast('تم تحديث الرسائل', 'info');
                } catch (error) {
                    showToast('حدث خطأ أثناء التحديث', 'error');
                } finally {
                    setIsRefreshing(false);
                }
            };
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                    <h2 className="text-2xl font-bold text-center text-indigo-600 mb-6">تم استلام الرمز بنجاح</h2>
                    
                    <div className="mb-6">
                        <div className="mb-2 text-gray-700">الخدمة: {service}</div>
                        <div className="bg-gray-50 p-8 rounded-lg flex items-center justify-center">
                            <div className="text-3xl font-bold tracking-widest text-indigo-700">{code}</div>
                        </div>
                        {message && (
                            <div className="mt-4 bg-gray-100 p-3 rounded-lg">
                                <div className="text-sm text-gray-700">نص الرسالة:</div>
                                <div className="mt-1 text-gray-900">{message}</div>
                            </div>
                        )}
                    </div>
                    
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center text-green-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                            </svg>
                            تم استلام الرمز بنجاح
                        </div>
                        <p className="mt-2 text-sm text-green-700">
                            يمكنك استخدام هذا الرمز للتحقق من حسابك. يرجى استخدامه خلال فترة صلاحيته.
                        </p>
                    </div>
                    
                    <div className="flex gap-3">
                        <button
                            className="flex-1 bg-indigo-600 text-white font-medium py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
                            onClick={onBack}
                        >
                            العودة للرقم
                        </button>
                        <button
                            className="px-4 bg-gray-200 text-gray-800 font-medium py-3 rounded-lg shadow-md hover:bg-gray-300 transition-colors"
                            onClick={() => {
                                navigator.clipboard.writeText(code);
                                showToast('تم نسخ الرمز إلى الحافظة', 'success');
                            }}
                        >
                            نسخ الرمز
                        </button>
                        <button
                            className={`px-4 bg-blue-100 text-blue-800 font-medium py-3 rounded-lg shadow-md hover:bg-blue-200 transition-colors ${isRefreshing ? 'opacity-50 cursor-not-allowed' : ''}`}
                            onClick={handleRefresh}
                            disabled={isRefreshing}
                        >
                            {isRefreshing ? 'جاري التحديث...' : 'تحديث'}
                        </button>
                    </div>
                </div>
            );
        };

        // مكون رأس الصفحة
        const Header = ({ user, onLogout }) => {
            return (
                <header className="bg-white shadow py-4 px-6 mb-8">
                    <div className="max-w-6xl mx-auto flex justify-between items-center">
                        <div className="flex items-center">
                            <div className="w-10 h-10 bg-gradient rounded-lg flex items-center justify-center text-white font-bold text-xl">
                                SMS
                            </div>
                            <h1 className="text-xl font-bold text-gray-800 mr-3">استقبال الأرقام الافتراضية</h1>
                        </div>
                        
                        {user && (
                            <div className="flex items-center">
                                <div className="hidden sm:flex items-center">
                                    <span className="text-gray-700 ml-3">{user.email}</span>
                                    <span className={`ml-3 px-2 py-1 rounded-full text-xs font-medium ${
                                        user.subscription === 'premium' ? 'bg-purple-100 text-purple-800' :
                                        user.subscription === 'basic' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    }`}>
                                        {user.subscription === 'premium' ? 'مميز' : 
                                         user.subscription === 'basic' ? 'عادي' : 'مجاني'}
                                    </span>
                                    {user.twoFactorEnabled && (
                                        <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                                            مؤمن بخطوتين
                                        </span>
                                    )}
                                </div>
                                <button
                                    className="bg-gray-100 text-gray-800 px-3 py-1 rounded-lg hover:bg-gray-200 transition-colors text-sm"
                                    onClick={onLogout}
                                >
                                    تسجيل الخروج
                                </button>
                            </div>
                        )}
                    </div>
                </header>
            );
        };

        // مكون لوحة التحكم
        const Dashboard = ({ user, setStep }) => {
            const [stats, setStats] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            
            useEffect(() => {
                const fetchStats = async () => {
                    setIsLoading(true);
                    try {
                        // محاكاة لاستدعاء API حقيقي
                        const response = await mockApiCall({
                            endpoint: '/api/users/stats',
                            method: 'GET'
                        });
                        
                        if (response.success) {
                            setStats(response.data);
                        }
                    } catch (error) {
                        console.error('Error fetching stats:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                
                fetchStats();
            }, []);
            
            return (
                <div className="bg-white rounded-lg shadow-lg p-6 max-w-lg w-full">
                    <h2 className="text-2xl font-bold text-center text-indigo-600 mb-6">لوحة التحكم</h2>
                    
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-indigo-50 p-4 rounded-lg">
                            <div className="text-indigo-800 font-medium">الباقة الحالية</div>
                            <div className="text-xl font-bold mt-1">
                                {user.subscription === 'premium' ? 'مميز' : 
                                 user.subscription === 'basic' ? 'عادي' : 'مجاني'}
                            </div>
                        </div>
                        <div className="bg-green-50 p-4 rounded-lg">
                            <div className="text-green-800 font-medium">الأرقام المتبقية</div>
                            <div className="text-xl font-bold mt-1">
                                {user.subscription === 'free' ? user.remainingNumbers : '∞'}
                            </div>
                        </div>
                    </div>
                    
                    <div className="mb-6">
                        <h3 className="font-medium text-gray-700 mb-2">إحصائيات الاستخدام</h3>
                        {isLoading ? (
                            <div className="h-20 flex items-center justify-center">
                                <div className="flex">
                                    <span className="loading-dot bg-indigo-600 w-2 h-2 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-indigo-600 w-2 h-2 rounded-full mx-1"></span>
                                    <span className="loading-dot bg-indigo-600 w-2 h-2 rounded-full mx-1"></span>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-2">
                                <div className="flex justify-between">
                                    <span>الأرقام المستخدمة اليوم</span>
                                    <span className="font-medium">{stats?.today || 0}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>الأرقام المستخدمة هذا الشهر</span>
                                    <span className="font-medium">{stats?.month || 0}</span>
                                </div>
                                <div className="flex justify-between">
                                    <span>إجمالي الأرقام المستخدمة</span>
                                    <span className="font-medium">{stats?.total || 0}</span>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="flex gap-3">
                        <button 
                            className="flex-1 bg-gradient text-white font-medium py-3 rounded-lg shadow-md hover:opacity-90 transition-all"
                            onClick={() => setStep('selectCountry')}
                        >
                            طلب رقم جديد
                        </button>
                        <button className="px-4 bg-gray-200 text-gray-800 font-medium py-3 rounded-lg shadow-md hover:bg-gray-300 transition-colors">
                            ترقية الباقة
                        </button>
                    </div>
                    
                    {user.twoFactorEnabled && (
                        <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div className="flex items-center text-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clipRule="evenodd" />
                                </svg>
                                التحقق بخطوتين مفعل
                            </div>
                            <p className="mt-2 text-sm text-blue-700">
                                حسابك محمي بإضافة طبقة أمان إضافية عند تسجيل الدخول.
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // ==============================================
        // التطبيق الرئيسي
        // ==============================================

        const App = () => {
            const [user, setUser] = useState(null);
            const [step, setStep] = useState('login');
            const [selectedCountry, setSelectedCountry] = useState(null);
            const [smsData, setSmsData] = useState({ code: null, service: '', message: '' });
            const [toast, setToast] = useState(null);
            const socketRef = useRef(null);
            
            // دالة لعرض الإشعارات
            const showToast = (message, type) => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };
            
            // تهيئة WebSocket عند تسجيل الدخول
            useEffect(() => {
                if (!user) return;
                
                // محاكاة اتصال WebSocket
                const socket = io('http://localhost:5000', {
                    auth: { token: user.token }
                });
                
                socketRef.current = socket;
                
                socket.on('connect', () => {
                    console.log('Connected to WebSocket server');
                });
                
                socket.on('disconnect', () => {
                    console.log('Disconnected from WebSocket server');
                });
                
                socket.on('connect_error', (err) => {
                    console.error('WebSocket connection error:', err);
                    showToast('فقدان الاتصال بالخادم، جاري إعادة المحاولة...', 'error');
                });
                
                return () => {
                    if (socket) socket.disconnect();
                };
            }, [user]);
            
            // دالة تسجيل الدخول
            const handleLogin = (userData) => {
                // محاكاة لبيانات المستخدم
                const mockUser = {
                    ...userData,
                    name: 'محمد أحمد',
                    subscription: 'free',
                    remainingNumbers: 3,
                    twoFactorEnabled: true
                };
                setUser(mockUser);
                setStep('dashboard');
            };
            
            // دالة تسجيل الخروج
            const handleLogout = () => {
                if (socketRef.current) {
                    socketRef.current.disconnect();
                    socketRef.current = null;
                }
                setUser(null);
                setStep('login');
                showToast('تم تسجيل الخروج بنجاح', 'success');
            };
            
            // دالة اختيار الدولة
            const handleCountrySelect = (country) => {
                setSelectedCountry(country);
                setStep('phoneNumber');
            };
            
            // دالة طلب رقم جديد
            const handleRequestNewNumber = () => {
                setStep('phoneNumber');
            };
            
            // دالة استقبال الرسائل
            const handleReceiveSMS = (code, service, message) => {
                setSmsData({ code, service, message });
                setStep('smsReceiver');
            };
            
            // دالة تحديث الرسائل
            const handleRefreshSMS = async () => {
                return new Promise(resolve => {
                    setTimeout(() => {
                        const newCode = Math.floor(Math.random() * 900000) + 100000;
                        setSmsData(prev => ({
                            ...prev,
                            code: newCode,
                            message: `رمز التحقق الجديد: ${newCode}. يرجى إدخاله في خلال 5 دقائق.`
                        }));
                        resolve();
                    }, 1000);
                });
            };
            
            // دالة محاكاة است��عاء API
            const mockApiCall = async ({ endpoint, method, data }) => {
                // محاكاة زمن الانتظار
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // محاكاة استجابة API لتسجيل الدخول
                if (endpoint === '/api/users/login' && method === 'POST') {
                    if (data.email === 'admin@example.com' && data.password === 'password') {
                        return {
                            success: true,
                            message: 'تم تسجيل الدخول بنجاح',
                            token: 'mock-jwt-token-123456',
                            user: {
                                email: data.email,
                                name: 'محمد أحمد',
                                subscription: 'premium',
                                twoFactorEnabled: true
                            }
                        };
                    } else {
                        return {
                            success: false,
                            message: 'البريد الإلكتروني أو كلمة المرور غير صحيحة'
                        };
                    }
                }
                
                // محاكاة استجابة API للتسجيل
                if (endpoint === '/api/users/register' && method === 'POST') {
                    return {
                        success: true,
                        message: 'تم إنشاء الحساب بنجاح',
                        token: 'mock-jwt-token-789012',
                        user: {
                            email: data.email,
                            name: data.name,
                            subscription: 'free',
                            twoFactorEnabled: false
                        }
                    };
                }
                
                // محاكاة استجابة API لجلب الدول
                if (endpoint === '/api/countries' && method === 'GET') {
                    return {
                        success: true,
                        data: [
                            { code: 'SA', name: 'السعودية', available: 125 },
                            { code: 'EG', name: 'مصر', available: 89 },
                            { code: 'AE', name: 'الإمارات', available: 63 },
                            { code: 'US', name: 'الولايات المتحدة', available: 208 },
                            { code: 'GB', name: 'المملكة المتحدة', available: 112 },
                            { code: 'RU', name: 'روسيا', available: 156 },
                            { code: 'IN', name: 'الهند', available: 245 },
                            { code: 'CA', name: 'كندا', available: 77 },
                        ]
                    };
                }
                
                // محاكاة استجابة API لجلب الخدمات
                if (endpoint === '/api/services' && method === 'GET') {
                    return {
                        success: true,
                        data: [
                            'واتساب', 'تليجرام', 'فيسبوك', 'تويتر', 
                            'جوجل', 'تيك توك', 'إنستجرام', 'أخرى'
                        ]
                    };
                }
                
                // محاكاة استجابة API لطلب رقم جديد
                if (endpoint === '/api/numbers/request' && method === 'POST') {
                    const countryCodes = {
                        'SA': '966',
                        'EG': '20',
                        'AE': '971',
                        'US': '1',
                        'GB': '44',
                        'RU': '7',
                        'IN': '91',
                        'CA': '1'
                    };
                    
                    const code = countryCodes[data.country] || '1';
                    const number = `+${code}${Math.floor(Math.random() * 9000000000) + 1000000000}`;
                    
                    return {
                        success: true,
                        message: 'تم الحصول على رقم جديد',
                        data: {
                            id: `num-${Math.random().toString(36).substr(2, 9)}`,
                            number,
                            expiresIn: 600 // 10 دقائق
                        }
                    };
                }
                
                // محاكاة استجابة API لتحرير رقم
                if (endpoint.includes('/api/numbers/') && endpoint.includes('/release') && method === 'POST') {
                    return {
                        success: true,
                        message: 'تم تحرير الرقم بنجاح'
                    };
                }
                
                // محاكاة استجابة API لجلب الرسائل
                if (endpoint.includes('/api/numbers/') && endpoint.includes('/messages') && method === 'GET') {
                    const code = Math.floor(Math.random() * 900000) + 100000;
                    return {
                        success: true,
                        data: [{
                            id: `msg-${Math.random().toString(36).substr(2, 9)}`,
                            code: code.toString(),
                            text: `رمز التحقق: ${code}. يرجى إدخاله في خلال 5 دقائق.`,
                            receivedAt: new Date().toISOString()
                        }]
                    };
                }
                
                // محاكاة استجابة API لإحصائيات المستخدم
                if (endpoint === '/api/users/stats' && method === 'GET') {
                    return {
                        success: true,
                        data: {
                            today: 5,
                            month: 32,
                            total: 128
                        }
                    };
                }
                
                // استجابة افتراضية
                return {
                    success: true,
                    message: 'تم تنفيذ العملية بنجاح'
                };
            };
            
            // عرض المكون المناسب حسب الخطوة الحالية
            const renderCurrentStep = () => {
                switch (step) {
                    case 'login':
                        return <LoginForm onLogin={handleLogin} showToast={showToast} />;
                    case 'dashboard':
                        return <Dashboard user={user} setStep={setStep} />;
                    case 'selectCountry':
                        return <CountrySelector onSelect={handleCountrySelect} showToast={showToast} />;
                    case 'phoneNumber':
                        return (
                            <PhoneNumber
                                country={selectedCountry}
                                onRequestNewNumber={handleRequestNewNumber}
                                onReceiveSMS={handleReceiveSMS}
                                showToast={showToast}
                                user={user}
                                socket={socketRef.current}
                            />
                        );
                    case 'smsReceiver':
                        return (
                            <SMSReceiver
                                code={smsData.code}
                                service={smsData.service}
                                message={smsData.message}
                                onBack={() => setStep('phoneNumber')}
                                onRefresh={handleRefreshSMS}
                                showToast={showToast}
                            />
                        );
                    default:
                        return <LoginForm onLogin={handleLogin} showToast={showToast} />;
                }
            };
            
            return (
                <div className="min-h-screen bg-gray-50">
                    <Header user={user} onLogout={handleLogout} />
                    <main className="max-w-6xl mx-auto px-4 pb-12">
                        <div className="flex justify-center">
                            {renderCurrentStep()}
                        </div>
                    </main>
                    
                    {/* عرض الإشعارات */}
                    {toast && (
                        <Toast 
                            message={toast.message} 
                            type={toast.type} 
                            onClose={() => setToast(null)} 
                        />
                    )}
                </div>
            );
        };

        // ==============================================
        // الخادم الخلفي (Backend) - النسخة المحسنة
        // ==============================================

        const backendCode = `
        // server.js - الملف الرئيسي للخادم
        const express = require('express');
        const mongoose = require('mongoose');
        const cors = require('cors');
        const axios = require('axios');
        const jwt = require('jsonwebtoken');
        const bcrypt = require('bcrypt');
        const rateLimit = require('express-rate-limit');
        const { check, validationResult } = require('express-validator');
        const helmet = require('helmet');
        const mongoSanitize = require('express-mongo-sanitize');
        const xss = require('xss-clean');
        const hpp = require('hpp');
        const http = require('http');
        const socketIo = require('socket.io');
        const redis = require('redis');
        const { promisify } = require('util');
        
        // إنشاء تطبيق إكسبرس
        const app = express();
        const server = http.createServer(app);
        const io = socketIo(server, {
            cors: {
                origin: "*",
                methods: ["GET", "POST"]
            }
        });
        
        const PORT = process.env.PORT || 5000;
        
        // اتصال Redis للتخزين المؤقت
        const redisClient = redis.createClient({
            host: process.env.REDIS_HOST || '127.0.0.1',
            port: process.env.REDIS_PORT || 6379
        });
        
        redisClient.on('error', (err) => {
            console.error('Redis connection error:', err);
        });
        
        const getAsync = promisify(redisClient.get).bind(redisClient);
        const setAsync = promisify(redisClient.set).bind(redisClient);
        const delAsync = promisify(redisClient.del).bind(redisClient);
        
        // الإعدادات الأمنية
        app.use(helmet());
        app.use(mongoSanitize());
        app.use(xss());
        app.use(hpp());
        
        // الإعدادات الأساسية
        app.use(express.json({ limit: '10kb' }));
        app.use(cors());
        
        // اتصال قاعدة البيانات
        mongoose.connect(process.env.MONGODB_URI || 'mongodb://localhost:27017/sms_receiver_db', {
            useNewUrlParser: true,
            useUnifiedTopology: true,
            useCreateIndex: true,
            useFindAndModify: false
        })
            .then(() => console.log('✅ تم الاتصال بقاعدة البيانات بنجاح'))
            .catch(err => console.error('❌ فشل الاتصال بقاعدة البيانات:', err));
        
        // تعريف نماذج البيانات (Models)
        const UserSchema = new mongoose.Schema({
            email: { type: String, required: true, unique: true },
            password: { type: String, required: true },
            name: { type: String, required: true },
            subscription: { type: String, enum: ['free', 'basic', 'premium'], default: 'free' },
            remainingNumbers: { type: Number, default: 5 },
            twoFactorEnabled: { type: Boolean, default: false },
            twoFactorSecret: { type: String },
            usageStats: {
                today: { type: Number, default: 0 },
                month: { type: Number, default: 0 },
                total: { type: Number, default: 0 }
            },
            createdAt: { type: Date, default: Date.now }
        });
        
        const PhoneNumberSchema = new mongoose.Schema({
            number: { type: String, required: true, unique: true },
            country: { code: String, name: String },
            isActive: { type: Boolean, default: true },
            user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
            expiresAt: { type: Date, default: Date.now() + 10*60*1000 }, // 10 دقائق
            service: { type: String },
            createdAt: { type: Date, default: Date.now }
        }, {
            indexes: [
                { expiresAt: 1 }, // فهرس لحذف الأرقام المنتهية تلقائياً
                { user: 1 }
            ]
        });
        
        PhoneNumberSchema.index({ expiresAt: 1 }, { expireAfterSeconds: 0 });
        
        const SMSMessageSchema = new mongoose.Schema({
            phoneNumber: { type: mongoose.Schema.Types.ObjectId, ref: 'PhoneNumber', required: true },
            sender: { type: String },
            message: { type: String, required: true },
            code: { type: String },
            service: { type: String },
            receivedAt: { type: Date, default: Date.now }
        }, {
            indexes: [
                { phoneNumber: 1 },
                { receivedAt: -1 } // فهرس للفرز حسب وقت الاستلام
            ]
        });
        
        // إنشاء النماذج
        const User = mongoose.model('User', UserSchema);
        const PhoneNumber = mongoose.model('PhoneNumber', PhoneNumberSchema);
        const SMSMessage = mongoose.model('SMSMessage', SMSMessageSchema);
        
        // معرِّف السر للـ JWT
        const JWT_SECRET = process.env.JWT_SECRET || 'your_secure_jwt_secret_here';
        const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';
        
        // ميدلوير التحقق من التوكن
        const auth = async (req, res, next) => {
            const token = req.header('x-auth-token');
            
            if (!token) {
                return res.status(401).json({ success: false, message: 'لا يوجد توكن، الوصول مرفوض' });
            }
            
            try {
                // التحقق من وجود التوكن في القائمة السوداء
                const isBlacklisted = await getAsync(`blacklist:${token}`);
                if (isBlacklisted) {
                    return res.status(401).json({ success: false, message: 'التوكن غير صالح' });
                }
                
                const decoded = jwt.verify(token, JWT_SECRET);
                req.user = await User.findById(decoded.user.id);
                
                if (!req.user) {
                    return res.status(401).json({ success: false, message: 'المستخدم غير موجود' });
                }
                
                next();
            } catch (err) {
                res.status(401).json({ success: false, message: 'التوكن غير صالح' });
            }
        };
        
        // ميدلوير Rate Limiting
        const loginLimiter = rateLimit({
            windowMs: 15 * 60 * 1000, // 15 دقيقة
            max: 5, // 5 محاولات كحد أقصى
            message: { success: false, message: 'محاولات كثيرة للغاية، يرجى المحاولة مرة أخرى بعد 15 دقيقة' }
        });
        
        const apiLimiter = rateLimit({
            windowMs: 60 * 60 * 1000, // ساعة واحدة
            max: 100, // 100 طلب كحد أقصى في الساعة
            message: { success: false, message: 'تم تجاوز الحد المسموح للطلبات، يرجى المحاولة لاحقًا' }
        });
        
        // WebSocket Authentication
        io.use((socket, next) => {
            const token = socket.handshake.auth.token;
            
            if (!token) {
                return next(new Error('التوكن مطلوب'));
            }
            
            jwt.verify(token, JWT_SECRET, async (err, decoded) => {
                if (err) {
                    return next(new Error('التوكن غير صالح'));
                }
                
                const user = await User.findById(decoded.user.id);
                if (!user) {
                    return next(new Error('المستخدم غير موجود'));
                }
                
                socket.user = user;
                next();
            });
        });
        
        // إدارة اتصالات WebSocket
        io.on('connection', (socket) => {
            console.log(\`New WebSocket connection: \${socket.id}\`);
            
            // الانضمام إلى غرفة الرقم
            socket.on('joinNumberRoom', (numberId) => {
                socket.join(\`number:\${numberId}\`);
                console.log(\`User joined number room: \${numberId}\`);
            });
            
            // مغادرة غرفة الرقم
            socket.on('leaveNumberRoom', (numberId) => {
                socket.leave(\`number:\${numberId}\`);
                console.log(\`User left number room: \${numberId}\`);
            });
            
            socket.on('disconnect', () => {
                console.log(\`Client disconnected: \${socket.id}\`);
            });
        });
        
        // دالة لإرسال رسالة SMS عبر WebSocket
        const sendSMSViaSocket = (numberId, message) => {
            io.to(\`number:\${numberId}\`).emit('newSMS', message);
        };
        
        // ==============================================
        // مسارات API
        // ==============================================
        
        // 1. تسجيل مستخدم جديد
        app.post('/api/users/register', [
            check('email', 'يرجى إدخال بريد إلكتروني صالح').isEmail(),
            check('password', 'يجب أن تكون كلمة المرور 6 أحرف على الأقل').isLength({ min: 6 }),
            check('name', 'الاسم مطلوب').not().isEmpty()
        ], async (req, res) => {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({ success: false, errors: errors.array() });
            }
        
            const { name, email, password } = req.body;
        
            try {
                // التحقق مما إذا كان المستخدم موجودًا بالفعل
                let user = await User.findOne({ email });
                if (user) {
                    return res.status(400).json({ success: false, message: 'المستخدم موجود بالفعل' });
                }
        
                user = new User({ name, email, password });
                const salt = await bcrypt.genSalt(10);
                user.password = await bcrypt.hash(password, salt);
                await user.save();
        
                const payload = { user: { id: user.id } };
                jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN }, (err, token) => {
                    if (err) throw err;
                    res.json({ 
                        success: true, 
                        token,
                        user: { 
                            email: user.email, 
                            name: user.name, 
                            subscription: user.subscription,
                            twoFactorEnabled: user.twoFactorEnabled
                        }
                    });
                });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 2. تسجيل الدخول
        app.post('/api/users/login', loginLimiter, [
            check('email', 'يرجى إدخال بريد إلكتروني صالح').isEmail(),
            check('password', 'كلمة المرور مطلوبة').exists()
        ], async (req, res) => {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({ success: false, errors: errors.array() });
            }
        
            const { email, password } = req.body;
        
            try {
                let user = await User.findOne({ email });
                if (!user) {
                    return res.status(400).json({ success: false, message: 'بيانات الاعتماد غير صحيحة' });
                }
        
                const isMatch = await bcrypt.compare(password, user.password);
                if (!isMatch) {
                    return res.status(400).json({ success: false, message: 'بيانات الاعتماد غير صحيحة' });
                }
        
                // إذا كان التحقق بخطوتين م��عل
                if (user.twoFactorEnabled) {
                    const twoFactorToken = jwt.sign(
                        { user: { id: user.id } },
                        JWT_SECRET,
                        { expiresIn: '10m' } // صلاحية 10 دقائق لإدخال الكود
                    );
                    
                    // هنا نرسل الكود إلى المستخدم (في تطبيق حقيقي، نرسله عبر البريد أو SMS)
                    const twoFactorCode = Math.floor(100000 + Math.random() * 900000);
                    
                    // تخزين الكود في Redis لمدة 10 دقائق
                    await setAsync(\`2fa:\${user._id}\`, twoFactorCode.toString(), 'EX', 600);
                    
                    return res.json({
                        success: true,
                        twoFactorRequired: true,
                        tempToken: twoFactorToken,
                        message: 'تم إرسال رمز التحقق إلى بريدك الإلكتروني'
                    });
                }
        
                const payload = { user: { id: user.id } };
                jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN }, (err, token) => {
                    if (err) throw err;
                    res.json({ 
                        success: true, 
                        token,
                        user: {
                            email: user.email,
                            name: user.name,
                            subscription: user.subscription,
                            twoFactorEnabled: user.twoFactorEnabled,
                            remainingNumbers: user.remainingNumbers
                        }
                    });
                });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 3. التحقق بخطوتين
        app.post('/api/users/verify-2fa', [
            check('code', 'رمز التحقق مطلوب').isLength({ min: 6, max: 6 }),
            check('tempToken', 'التوكن المؤقت مطلوب').not().isEmpty()
        ], async (req, res) => {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({ success: false, errors: errors.array() });
            }
        
            const { code, tempToken } = req.body;
        
            try {
                const decoded = jwt.verify(tempToken, JWT_SECRET);
                const user = await User.findById(decoded.user.id);
                
                if (!user) {
                    return res.status(400).json({ success: false, message: 'المستخدم غير موجود' });
                }
                
                // التحقق من صحة الكود
                const savedCode = await getAsync(\`2fa:\${user._id}\`);
                if (!savedCode || savedCode !== code) {
                    return res.status(400).json({ success: false, message: 'رمز التحقق غير صحيح' });
                }
                
                // حذف الكود من Redis بعد استخدامه
                await delAsync(\`2fa:\${user._id}\`);
                
                // إنشاء توكن الدخول النهائي
                const payload = { user: { id: user.id } };
                jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN }, (err, token) => {
                    if (err) throw err;
                    res.json({ 
                        success: true, 
                        token,
                        user: {
                            email: user.email,
                            name: user.name,
                            subscription: user.subscription,
                            twoFactorEnabled: user.twoFactorEnabled,
                            remainingNumbers: user.remainingNumbers
                        }
                    });
                });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 4. تسجيل الخروج
        app.post('/api/users/logout', auth, async (req, res) => {
            try {
                // إضافة التوكن إلى القائمة السوداء في Redis
                const token = req.header('x-auth-token');
                await setAsync(\`blacklist:\${token}\`, '1', 'EX', 86400); // صلاحية 24 ساعة
                
                res.json({ success: true, message: 'تم تسجيل الخروج بنجاح' });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 5. جلب الدول المتاحة (مع التخزين المؤقت)
        app.get('/api/countries', auth, apiLimiter, async (req, res) => {
            try {
                // التحقق من وجود البيانات في الكاش
                const cachedCountries = await getAsync('countries');
                
                if (cachedCountries) {
                    return res.json({ 
                        success: true, 
                        data: JSON.parse(cachedCountries),
                        cached: true
                    });
                }
                
                // في تطبيق حقيقي، ستأتي هذه البيانات من مزود الخدمة (API Provider)
                const countries = [
                    { code: 'SA', name: 'السعودية', available: 125 },
                    { code: 'EG', name: 'مصر', available: 89 },
                    { code: 'AE', name: 'الإمارات', available: 63 },
                    { code: 'US', name: 'الولايات المتحدة', available: 208 },
                    { code: 'GB', name: 'المملكة المتحدة', available: 112 },
                    { code: 'RU', name: 'روسيا', available: 156 },
                    { code: 'IN', name: 'الهند', available: 245 },
                    { code: 'CA', name: 'كندا', available: 77 },
                ];
                
                // تخزين البيانات في الكاش لمدة 5 دقائق
                await setAsync('countries', JSON.stringify(countries), 'EX', 300);
                
                res.json({ success: true, data: countries });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 6. طلب رقم جديد
        app.post('/api/numbers/request', auth, apiLimiter, [
            check('country', 'البلد مطلوب').not().isEmpty()
        ], async (req, res) => {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({ success: false, errors: errors.array() });
            }
        
            const { country } = req.body;
            const user = req.user;
        
            try {
                // التحقق من أن المستخدم لديه أرقام متبقية
                if (user.subscription === 'free' && user.remainingNumbers <= 0) {
                    return res.status(400).json({ 
                        success: false, 
                        message: 'لقد استخدمت جميع الأرقام المتاحة لك اليوم، يرجى ترقية حسابك' 
                    });
                }
        
                // في تطبيق حقيقي، هنا ستقوم بالاتصال بمزود خدمة الأرقام (مثل 5sim.net)
                // هذا مثال محاكاة
                const countryCodes = {
                    'SA': { code: '966', name: 'السعودية' },
                    'EG': { code: '20', name: 'مصر' },
                    'AE': { code: '971', name: 'الإمارات' },
                    'US': { code: '1', name: 'الولايات المتحدة' },
                    'GB': { code: '44', name: 'المملكة المتحدة' },
                    'RU': { code: '7', name: 'روسيا' },
                    'IN': { code: '91', name: 'الهند' },
                    'CA': { code: '1', name: 'كندا' }
                };
                
                const countryInfo = countryCodes[country] || { code: '1', name: 'غير معروف' };
                const number = '+' + countryInfo.code + Math.floor(Math.random() * 900000000 + 100000000);
                
                // حفظ الرقم في قاعدة البيانات
                const phoneNumber = new PhoneNumber({
                    number,
                    country: { code: country, name: countryInfo.name },
                    user: user._id,
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 دقائق
                });
                
                await phoneNumber.save();
                
                // تحديث عدد الأرقام المتبقية للمستخدم (إذا كان حساب مجاني)
                if (user.subscription === 'free') {
                    user.remainingNumbers -= 1;
                    await user.save();
                }
                
                // تحديث إحصائيات الاستخدام
                await User.updateOne(
                    { _id: user._id },
                    { 
                        \$inc: { 
                            'usageStats.today': 1,
                            'usageStats.month': 1,
                            'usageStats.total': 1
                        } 
                    }
                );
                
                res.json({ 
                    success: true, 
                    data: {
                        id: phoneNumber._id,
                        number: phoneNumber.number,
                        country: phoneNumber.country,
                        expiresIn: 600 // 10 دقائق بالثواني
                    }
                });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 7. تحرير رقم
        app.post('/api/numbers/:id/release', auth, apiLimiter, async (req, res) => {
            try {
                const phoneNumber = await PhoneNumber.findById(req.params.id);
                
                if (!phoneNumber) {
                    return res.status(404).json({ success: false, message: 'الرقم غير موجود' });
                }
                
                // في تطبيق حقيقي، هنا ستقوم بإعلام مزود الخدمة بتحرير الرقم
                phoneNumber.isActive = false;
                await phoneNumber.save();
                
                res.json({ success: true, message: 'تم تحرير الرقم بنجاح' });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 8. جلب الرسائل الواردة لرقم معين
        app.get('/api/numbers/:id/messages', auth, apiLimiter, async (req, res) => {
            try {
                const phoneNumber = await PhoneNumber.findById(req.params.id);
                
                if (!phoneNumber) {
                    return res.status(404).json({ success: false, message: 'الرقم غير موجود' });
                }
                
                // التحقق من أن المستخدم يملك هذا الرقم
                if (phoneNumber.user.toString() !== req.user._id.toString()) {
                    return res.status(403).json({ success: false, message: 'غير مصرح بالوصول إلى هذا الرقم' });
                }
                
                // في تطبيق حقيقي، هنا ستقوم بالاتصال بمزود الخدمة لجلب الرسائل
                // هذا مثال محاكاة
                const messages = await SMSMessage.find({ phoneNumber: phoneNumber._id })
                    .sort({ receivedAt: -1 })
                    .limit(10)
                    .lean(); // استخدام lean() لتحسين الأداء
                
                res.json({ success: true, data: messages });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 9. معلومات المستخدم
        app.get('/api/users/me', auth, async (req, res) => {
            try {
                const user = req.user;
                res.json({ 
                    success: true, 
                    data: {
                        email: user.email,
                        name: user.name,
                        subscription: user.subscription,
                        remainingNumbers: user.remainingNumbers,
                        twoFactorEnabled: user.twoFactorEnabled,
                        usageStats: user.usageStats
                    }
                });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 10. إحصائيات المستخدم
        app.get('/api/users/stats', auth, async (req, res) => {
            try {
                // استخدام التجميع (aggregation) لتحسين استعلامات قاعدة البيانات
                const stats = await User.aggregate([
                    { \$match: { _id: req.user._id } },
                    { \$project: {
                        today: '\$usageStats.today',
                        month: '\$usageStats.month',
                        total: '\$usageStats.total'
                    }}
                ]);
                
                if (stats.length === 0) {
                    return res.status(404).json({ success: false, message: 'المستخدم غير موجود' });
                }
                
                res.json({ success: true, data: stats[0] });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // 11. محاكاة استقبال رسالة SMS (للتطوير فقط)
        app.post('/api/dev/simulate-sms', [
            check('numberId', 'معرّف الرقم مطلوب').not().isEmpty(),
            check('message', 'نص الرسالة مطلوب').not().isEmpty()
        ], async (req, res) => {
            const errors = validationResult(req);
            if (!errors.isEmpty()) {
                return res.status(400).json({ success: false, errors: errors.array() });
            }
            
            const { numberId, message } = req.body;
            
            try {
                // استخراج رمز التحقق من الرسالة (إذا وجد)
                const codeMatch = message.match(/\\b\\d{4,6}\\b/);
                const code = codeMatch ? codeMatch[0] : null;
                
                // حفظ الرسالة في قاعدة البيانات
                const smsMessage = new SMSMessage({
                    phoneNumber: numberId,
                    message,
                    code,
                    receivedAt: new Date()
                });
                
                await smsMessage.save();
                
                // إرسال الرسالة عبر WebSocket
                sendSMSViaSocket(numberId, {
                    numberId,
                    code,
                    text: message
                });
                
                res.json({ success: true, message: 'تم استلام الرسالة بنجاح' });
            } catch (err) {
                console.error(err.message);
                res.status(500).json({ success: false, message: 'خطأ في الخادم' });
            }
        });
        
        // تشغيل الخادم
        server.listen(PORT, () => {
            console.log(\`🚀 الخادم يعمل على http://localhost:\${PORT}\`);
        });
        `;

        // ==============================================
        // تشغيل التطبيق
        // ==============================================

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
